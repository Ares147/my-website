<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KanaShop23 - Эксклюзивные товары</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: #000000;
            border-color: #ffffff;
        }
        .item-card {
            transition: all 0.3s ease;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .blur-effect {
            filter: blur(5px);
            transition: filter 0.3s ease;
        }
        .blur-effect:hover {
            filter: blur(0);
        }
        .hidden-content {
            display: none;
        }
        .revealed {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-black font-sans">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-cannabis text-2xl text-emerald-500"></i>
                <span class="text-xl font-bold text-emerald-400">KanaShop23</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="cartBtn" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg transition hidden">
                    <i class="fas fa-shopping-cart"></i> Корзина
                </button>
                <button id="loginBtn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg transition text-white">Вход</button>
                <button id="registerBtn" class="px-4 py-2 bg-emerald-800 hover:bg-emerald-900 rounded-lg transition text-white">Регистрация</button>
                <button id="adminBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition text-white hidden">Админ</button>
                <button id="accountBtn" class="px-4 py-2 bg-emerald-700 hover:bg-emerald-800 rounded-lg transition text-white hidden">Аккаунт</button>
                <button id="logoutBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-800 rounded-lg transition text-white hidden">Выход</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Items Grid -->
        <section id="itemsSection" class="mb-12 mt-8">
            <h2 class="text-3xl font-bold mb-6 text-emerald-400 border-b border-emerald-500 pb-2">Каталог KanaShop23</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="itemsGrid">
                <!-- Items will be loaded here dynamically -->
            </div>
        </section>

        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-900 rounded-lg p-6 w-full max-w-md border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Вход</h3>
                    <button id="closeLoginModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginUsername" class="block text-gray-700 mb-1">Username</label>
                        <input type="text" id="loginUsername" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-gray-700 mb-1">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Login</button>
                </form>
            </div>
        </div>

        <!-- Register Modal -->
        <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Регистрация</h3>
                    <button id="closeRegisterModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Your username will be generated automatically</label>
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-gray-700 mb-1">Create Password</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-gray-700 mb-1">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Register</button>
                </form>
            </div>
        </div>

        <!-- Account Modal -->
        <div id="accountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Мой аккаунт</h3>
                    <button id="closeAccountModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700">Account Info</h4>
                        <p id="accountUsername" class="text-gray-600">Username: </p>
                        <p id="accountBalance" class="text-gray-600">Balance: $0.00</p>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Deposit Funds</h4>
                        <div id="paymentDetails" class="bg-gray-100 p-4 rounded-lg mb-3">
                            <p class="font-semibold">Payment details will appear here</p>
                        </div>
                        <div class="flex space-x-2">
                            <input type="number" id="depositAmount" class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Amount" min="1">
                            <button id="generatePaymentBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Generate</button>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">2FA Settings</h4>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="enable2FA" class="mr-2">
                                <label for="enable2FA">Enable Two-Factor Authentication</label>
                            </div>
                            <div id="2faSetup" class="hidden bg-gray-100 p-3 rounded">
                                <p class="text-sm mb-2">Scan this QR code with your authenticator app:</p>
                                <div id="2faQrCode" class="mb-3"></div>
                                <p class="text-sm mb-2">Or enter this secret key manually:</p>
                                <p id="2faSecret" class="font-mono bg-white p-2 rounded mb-3"></p>
                                <div>
                                    <label class="block text-sm mb-1">Enter code to verify:</label>
                                    <input type="text" id="2faCode" class="w-full px-3 py-2 border rounded mb-2">
                                    <button id="verify2faBtn" class="px-3 py-1 bg-blue-600 text-white rounded">Verify</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 border-t">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">My Purchases</h4>
                        <div id="purchasesList" class="space-y-2">
                            <p class="text-gray-500">No purchases yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Modal -->
        <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Ваши покупки (10 дней)</h3>
                    <button id="closeCartModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="cartItems" class="space-y-4">
                    <!-- Purchased items will be shown here -->
                </div>
            </div>
        </div>

        <!-- Admin Modal -->
        <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Админ панель</h3>
                    <button id="closeAdminModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add New Item -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Add New Item</h4>
                        <form id="addItemForm" class="space-y-3">
                            <div>
                                <label class="block text-gray-700 mb-1">Name</label>
                                <input type="text" id="itemName" class="w-full px-3 py-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Description</label>
                                <textarea id="itemDescription" class="w-full px-3 py-2 border rounded-lg" rows="3" required></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Price ($)</label>
                                <input type="number" id="itemPrice" class="w-full px-3 py-2 border rounded-lg" min="1" step="0.01" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Weight (kg)</label>
                                <input type="number" id="itemWeight" class="w-full px-3 py-2 border rounded-lg" min="0.1" step="0.1" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Image URL</label>
                                <input type="text" id="itemImage" class="w-full px-3 py-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Stash Location (hidden until purchase)</label>
                                <textarea id="itemLocation" class="w-full px-3 py-2 border rounded-lg" rows="2" required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Add Item</button>
                        </form>
                    </div>
                    
                    <!-- Manage Items -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Manage Items</h4>
                        <div id="adminItemsList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Items will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Payment Details -->
                    <div class="bg-gray-50 p-4 rounded-lg md:col-span-2">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Payment Details</h4>
                        <form id="paymentDetailsForm" class="space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-gray-700 mb-1">Bank Name</label>
                                    <input type="text" id="bankName" class="w-full px-3 py-2 border rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-1">Account Number</label>
                                    <input type="text" id="accountNumber" class="w-full px-3 py-2 border rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-1">Account Holder</label>
                                    <input type="text" id="accountHolder" class="w-full px-3 py-2 border rounded-lg" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Additional Instructions</label>
                                <textarea id="paymentInstructions" class="w-full px-3 py-2 border rounded-lg" rows="2"></textarea>
                            </div>
                            <div class="flex justify-between">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Update Details</button>
                                <button type="button" id="clearPaymentDetails" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Clear Details</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- User Management -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">User Management</h4>
                        <div class="flex mb-3">
                            <input type="text" id="searchUserId" placeholder="User ID" class="px-3 py-2 border rounded-l-lg w-1/3">
                            <button id="searchUserBtn" class="px-4 py-2 bg-blue-600 text-white">Search</button>
                        </div>
                        <div id="userDetails" class="bg-white p-3 rounded-lg shadow mb-3 hidden">
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm">Username</label>
                                    <p id="userUsername" class="font-medium"></p>
                                </div>
                                <div>
                                    <label class="block text-sm">Balance</label>
                                    <input type="number" id="userBalance" class="w-full px-2 py-1 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm">Status</label>
                                    <p id="userStatus" class="font-medium"></p>
                                </div>
                                <div>
                                    <label class="block text-sm">2FA</label>
                                    <p id="user2FA" class="font-medium"></p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="blockUserBtn" class="px-3 py-1 bg-red-600 text-white rounded">Block</button>
                                <button id="unblockUserBtn" class="px-3 py-1 bg-green-600 text-white rounded">Unblock</button>
                                <button id="deleteUserBtn" class="px-3 py-1 bg-red-800 text-white rounded">Delete</button>
                                <button id="saveUserBtn" class="px-3 py-1 bg-blue-600 text-white rounded ml-auto">Save Changes</button>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="bg-gray-50 p-4 rounded-lg md:col-span-2">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Сообщения от пользователей</h4>
                        <div id="messagesList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Messages will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Pending Payments -->
                    <div class="bg-gray-50 p-4 rounded-lg md:col-span-2">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Pending Payments</h4>
                        <div id="pendingPaymentsList" class="space-y-3">
                            <!-- Payments will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Сообщение администратору</h3>
                    <button id="closeMessageModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="messageForm" class="space-y-4">
                    <div>
                        <label for="messageText" class="block text-gray-700 mb-1">Ваше сообщение</label>
                        <textarea id="messageText" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Отправить</button>
                </form>
            </div>
        </div>

        <!-- Item Details Modal -->
        <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="itemModalTitle" class="text-2xl font-bold text-gray-800">Item Details</h3>
                    <button id="closeItemModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img id="itemModalImage" src="" alt="Item image" class="w-full h-64 object-cover rounded-lg">
                    </div>
                    <div>
                        <p id="itemModalDescription" class="text-gray-700 mb-4"></p>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-gray-500">Price</p>
                                <p id="itemModalPrice" class="text-xl font-bold text-blue-600"></p>
                            </div>
                            <div>
                                <p class="text-gray-500">Weight</p>
                                <p id="itemModalWeight" class="text-lg"></p>
                            </div>
                        </div>
                        <div id="itemLocationSection" class="mb-4 hidden">
                            <p class="text-gray-500">Stash Location</p>
                            <p id="itemModalLocation" class="font-mono bg-gray-100 p-2 rounded"></p>
                        </div>
                        <button id="buyItemBtn" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Purchase for <span id="itemModalPriceBtn"></span></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="gradient-bg text-white py-6 border-t border-gray-700">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center mb-2">
                <i class="fas fa-cannabis text-emerald-400"></i>
            </div>
            <p class="text-emerald-300">&copy; 2023 KanaShop23. Все права защищены.</p>
        </div>
    </footer>

    <script>
        // State management
        const state = {
            messages: [],
            otpSecrets: {}, // Store 2FA secrets
            currentUser: null,
            isAdmin: false,
            items: [
                {
                    id: 1,
                    name: "Premium Watch",
                    description: "Luxury automatic watch with sapphire crystal and stainless steel case.",
                    price: 899.99,
                    weight: 0.15,
                    image: "https://images.unsplash.com/photo-1523170335258-f5ed11844a49?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=880&q=80",
                    location: "Under the third bench in Central Park, near the statue. Coordinates: 40.7829° N, 73.9654° W"
                },
                {
                    id: 2,
                    name: "Designer Bag",
                    description: "Authentic leather handbag with gold hardware and multiple compartments.",
                    price: 1250.00,
                    weight: 0.8,
                    image: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=736&q=80",
                    location: "Inside the red locker at Grand Central Station, code 7421"
                },
                {
                    id: 3,
                    name: "Limited Sneakers",
                    description: "Rare edition sneakers in mint condition, only 500 pairs made worldwide.",
                    price: 650.00,
                    weight: 0.6,
                    image: "https://images.unsplash.com/photo-1600269452121-4f2416e55c28?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=736&q=80",
                    location: "Buried 1 meter deep at the oak tree in Prospect Park, Brooklyn"
                }
            ],
            users: [
                { 
                    username: "ares14", 
                    password: "Sergbe25", 
                    balance: 0, 
                    isAdmin: true, 
                    purchases: [] 
                },
                { 
                    username: "user1", 
                    password: "pass123", 
                    balance: 1500, 
                    isAdmin: false, 
                    purchases: [
                        {
                            itemId: 1,
                            date: new Date(Date.now() - 86400000 * 2).toISOString() // 2 days ago
                        }
                    ] 
                }
            ],
            paymentDetails: {
                bankName: "Global Trust Bank",
                accountNumber: "1234567890",
                accountHolder: "Secret Stash LLC",
                instructions: "Include the generated payment code in the transaction reference"
            },
            pendingPayments: []
        };

        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const adminBtn = document.getElementById('adminBtn');
        const accountBtn = document.getElementById('accountBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const exploreBtn = document.getElementById('exploreBtn');
        
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const accountModal = document.getElementById('accountModal');
        const adminModal = document.getElementById('adminModal');
        const itemModal = document.getElementById('itemModal');
        
        const closeLoginModal = document.getElementById('closeLoginModal');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const closeAccountModal = document.getElementById('closeAccountModal');
        const closeAdminModal = document.getElementById('closeAdminModal');
        const closeItemModal = document.getElementById('closeItemModal');
        const messageModal = document.getElementById('messageModal');
        const closeMessageModal = document.getElementById('closeMessageModal');
        const messageForm = document.getElementById('messageForm');
        
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const addItemForm = document.getElementById('addItemForm');
        const paymentDetailsForm = document.getElementById('paymentDetailsForm');
        
        const itemsGrid = document.getElementById('itemsGrid');
        const adminItemsList = document.getElementById('adminItemsList');
        const pendingPaymentsList = document.getElementById('pendingPaymentsList');
        const purchasesList = document.getElementById('purchasesList');
        const paymentDetails = document.getElementById('paymentDetails');
        
        // Current item being viewed
        let currentItem = null;

        // Initialize the app
        function init() {
            // Cart button handlers
            document.getElementById('cartBtn').addEventListener('click', showCart);
            document.getElementById('closeCartModal').addEventListener('click', () => {
                document.getElementById('cartModal').classList.add('hidden');
            });
            // 2FA setup handlers
            document.getElementById('enable2FA').addEventListener('change', function() {
                const setupDiv = document.getElementById('2faSetup');
                if (this.checked) {
                    setup2FA();
                    setupDiv.classList.remove('hidden');
                } else {
                    setupDiv.classList.add('hidden');
                    if (state.currentUser) {
                        delete state.otpSecrets[state.currentUser.username];
                    }
                }
            });

            document.getElementById('verify2faBtn').addEventListener('click', verify2FA);

            // Admin user management handlers
            document.getElementById('searchUserBtn').addEventListener('click', searchUser);
            document.getElementById('blockUserBtn').addEventListener('click', () => updateUserStatus('blocked'));
            document.getElementById('unblockUserBtn').addEventListener('click', () => updateUserStatus('active'));
            document.getElementById('deleteUserBtn').addEventListener('click', deleteUser);
            document.getElementById('saveUserBtn').addEventListener('click', saveUserChanges);
            // Message modal handlers
            closeMessageModal.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });
            
            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const messageText = document.getElementById('messageText').value;
                
                if (messageText && currentItem) {
                    state.messages.push({
                        username: state.currentUser.username,
                        itemId: currentItem.id,
                        message: messageText,
                        date: new Date().toISOString()
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('messages', JSON.stringify(state.messages));
                    
                    alert('Сообщение отправлено администратору!');
                    messageModal.classList.add('hidden');
                    document.getElementById('messageText').value = '';
                }
            });
            renderItems();
            updateUI();
            
            // Load payment details if they exist in localStorage
            const savedPaymentDetails = localStorage.getItem('paymentDetails');
            if (savedPaymentDetails) {
                state.paymentDetails = JSON.parse(savedPaymentDetails);
            }
            
            // Load items if they exist in localStorage
            const savedItems = localStorage.getItem('items');
            if (savedItems) {
                state.items = JSON.parse(savedItems);
                renderItems();
            }
            
            // Load users if they exist in localStorage
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                state.users = JSON.parse(savedUsers);
            }
            
            // Load pending payments if they exist in localStorage
            const savedPendingPayments = localStorage.getItem('pendingPayments');
            if (savedPendingPayments) {
                state.pendingPayments = JSON.parse(savedPendingPayments);
            }
        }

        // Update UI based on authentication state
        function updateUI() {
            if (state.currentUser) {
                loginBtn.classList.add('hidden');
                registerBtn.classList.add('hidden');
                accountBtn.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                document.getElementById('cartBtn').classList.remove('hidden');
                
                if (state.isAdmin) {
                    adminBtn.classList.remove('hidden');
                } else {
                    adminBtn.classList.add('hidden');
                }
            } else {
                loginBtn.classList.remove('hidden');
                registerBtn.classList.remove('hidden');
                accountBtn.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                adminBtn.classList.add('hidden');
            }
        }

        // Render items to the grid
        function renderItems() {
            itemsGrid.innerHTML = '';
            
            state.items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card bg-gray-900 rounded-xl overflow-hidden shadow-md border border-gray-700';
                itemCard.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-xl font-bold text-white mb-2">${item.name}</h3>
                        <p class="text-gray-300 mb-3 line-clamp-2">${item.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-blue-600">$${item.price.toFixed(2)}</span>
                            <button class="view-item-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" data-id="${item.id}">
                                View Details
                            </button>
                        </div>
                    </div>
                `;
                itemsGrid.appendChild(itemCard);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = parseInt(e.target.getAttribute('data-id'));
                    viewItem(itemId);
                });
            });
        }

        // View item details
        function viewItem(id) {
            currentItem = state.items.find(item => item.id === id);
            
            if (!currentItem) return;
            
            document.getElementById('itemModalTitle').textContent = currentItem.name;
            document.getElementById('itemModalImage').src = currentItem.image;
            document.getElementById('itemModalDescription').textContent = currentItem.description;
            document.getElementById('itemModalPrice').textContent = `$${currentItem.price.toFixed(2)}`;
            document.getElementById('itemModalWeight').textContent = `${currentItem.weight} kg`;
            document.getElementById('itemModalPriceBtn').textContent = `$${currentItem.price.toFixed(2)}`;
            
            // Check if user has purchased this item
            const hasPurchased = state.currentUser && 
                                state.currentUser.purchases.some(p => p.itemId === id);
            
            if (hasPurchased) {
                document.getElementById('itemLocationSection').classList.remove('hidden');
                document.getElementById('itemModalLocation').textContent = currentItem.location;
                document.getElementById('buyItemBtn').classList.add('hidden');
            } else {
                document.getElementById('itemLocationSection').classList.add('hidden');
                document.getElementById('buyItemBtn').classList.remove('hidden');
            }
            
            itemModal.classList.remove('hidden');
        }

        // Render messages in admin panel
        function renderMessages() {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';
            
            if (state.messages.length === 0) {
                messagesList.innerHTML = '<p class="text-gray-500">Нет сообщений</p>';
                return;
            }
            
            state.messages.forEach(msg => {
                const item = state.items.find(i => i.id === msg.itemId);
                const user = state.users.find(u => u.username === msg.username);
                
                const msgElement = document.createElement('div');
                msgElement.className = 'bg-white p-3 rounded-lg shadow';
                msgElement.innerHTML = `
                    <div class="mb-2">
                        <span class="font-semibold">${msg.username}</span>
                        <span class="text-sm text-gray-500 ml-2">${new Date(msg.date).toLocaleString()}</span>
                    </div>
                    <div class="mb-2">
                        <p class="text-sm text-gray-600">Товар: ${item ? item.name : 'Unknown'}</p>
                    </div>
                    <div class="bg-gray-100 p-2 rounded">
                        <p>${msg.message}</p>
                    </div>
                `;
                messagesList.appendChild(msgElement);
            });
        }

        // Render admin items list
        function renderAdminItems() {
            adminItemsList.innerHTML = '';
            
            state.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'bg-white p-3 rounded-lg shadow';
                itemElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${item.name}</h4>
                            <p class="text-sm text-gray-600">$${item.price.toFixed(2)} | ${item.weight}kg</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-item-btn px-2 py-1 bg-yellow-500 text-white rounded text-sm" data-id="${item.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-item-btn px-2 py-1 bg-red-500 text-white rounded text-sm" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                adminItemsList.appendChild(itemElement);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = parseInt(e.target.closest('button').getAttribute('data-id'));
                    editItem(itemId);
                });
            });
            
            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = parseInt(e.target.closest('button').getAttribute('data-id'));
                    deleteItem(itemId);
                });
            });
        }

        // Edit item (placeholder - would need a proper form)
        function editItem(id) {
            const item = state.items.find(item => item.id === id);
            if (!item) return;
            
            alert(`Editing ${item.name}. In a full implementation, this would open an edit form.`);
        }

        // Delete item
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                state.items = state.items.filter(item => item.id !== id);
                localStorage.setItem('items', JSON.stringify(state.items));
                renderItems();
                renderAdminItems();
            }
        }

        // Render pending payments
        function renderPendingPayments() {
            pendingPaymentsList.innerHTML = '';
            
            if (state.pendingPayments.length === 0) {
                pendingPaymentsList.innerHTML = '<p class="text-gray-500">No pending payments</p>';
                return;
            }
            
            state.pendingPayments.forEach(payment => {
                const user = state.users.find(u => u.username === payment.username);
                const paymentElement = document.createElement('div');
                paymentElement.className = 'bg-white p-3 rounded-lg shadow';
                paymentElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${payment.username}</h4>
                            <p class="text-sm text-gray-600">Amount: $${payment.amount.toFixed(2)}</p>
                            <p class="text-sm text-gray-600">Code: ${payment.code}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="approve-payment-btn px-3 py-1 bg-green-500 text-white rounded text-sm" data-username="${payment.username}" data-amount="${payment.amount}">
                                Approve
                            </button>
                            <button class="reject-payment-btn px-3 py-1 bg-red-500 text-white rounded text-sm" data-username="${payment.username}" data-amount="${payment.amount}">
                                Reject
                            </button>
                        </div>
                    </div>
                `;
                pendingPaymentsList.appendChild(paymentElement);
            });
            
            // Add event listeners to approve/reject buttons
            document.querySelectorAll('.approve-payment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-username');
                    const amount = parseFloat(e.target.getAttribute('data-amount'));
                    approvePayment(username, amount);
                });
            });
            
            document.querySelectorAll('.reject-payment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const username = e.target.getAttribute('data-username');
                    const amount = parseFloat(e.target.getAttribute('data-amount'));
                    rejectPayment(username, amount);
                });
            });
        }

        // Approve payment
        function approvePayment(username, amount) {
            const user = state.users.find(u => u.username === username);
            if (user) {
                user.balance += amount;
                
                // Remove from pending payments
                state.pendingPayments = state.pendingPayments.filter(
                    p => !(p.username === username && p.amount === amount)
                );
                
                // Save to localStorage
                localStorage.setItem('users', JSON.stringify(state.users));
                localStorage.setItem('pendingPayments', JSON.stringify(state.pendingPayments));
                
                // Update UI
                if (state.currentUser && state.currentUser.username === username) {
                    state.currentUser.balance = user.balance;
                    updateAccountModal();
                }
                
                renderPendingPayments();
                alert(`Approved payment of $${amount.toFixed(2)} for ${username}`);
            }
        }

        // Reject payment
        function rejectPayment(username, amount) {
            if (confirm(`Reject payment of ${amount.toFixed(2)} from ${username}?`)) {
                state.pendingPayments = state.pendingPayments.filter(
                    p => !(p.username === username && p.amount === amount)
                );
                
                localStorage.setItem('pendingPayments', JSON.stringify(state.pendingPayments));
                renderPendingPayments();
                alert(`Rejected payment of ${amount.toFixed(2)} from ${username}`);
            }
        }

        // 2FA Functions
        function setup2FA() {
            if (!state.currentUser) return;
            
            // Generate a random secret (in real app, use a proper OTP library)
            const secret = Math.random().toString(36).substring(2, 15) + 
                          Math.random().toString(36).substring(2, 15);
            
            state.otpSecrets[state.currentUser.username] = secret;
            document.getElementById('2faSecret').textContent = secret;
            
            // In a real app, generate a proper QR code here
            document.getElementById('2faQrCode').innerHTML = 
                `<div class="bg-gray-200 p-4 text-center">QR Code would appear here for secret: ${secret}</div>`;
        }

        function verify2FA() {
            const code = document.getElementById('2faCode').value;
            if (!code) {
                alert('Please enter the code from your authenticator app');
                return;
            }
            
            // In a real app, verify against the OTP secret
            alert('2FA verification would happen here. For demo purposes, any code is accepted.');
            
            document.getElementById('enable2FA').disabled = true;
            document.getElementById('2faSetup').classList.add('hidden');
            alert('2FA has been successfully enabled for your account!');
        }

        // Admin User Management Functions
        function searchUser() {
            const userId = document.getElementById('searchUserId').value;
            if (!userId) return;
            
            const user = state.users.find(u => u.username === userId);
            if (!user) {
                alert('User not found');
                return;
            }
            
            const userDetails = document.getElementById('userDetails');
            document.getElementById('userUsername').textContent = user.username;
            document.getElementById('userBalance').value = user.balance;
            document.getElementById('userStatus').textContent = user.status || 'active';
            document.getElementById('user2FA').textContent = state.otpSecrets[user.username] ? 'Enabled' : 'Disabled';
            
            userDetails.classList.remove('hidden');
        }

        function updateUserStatus(status) {
            const userId = document.getElementById('searchUserId').value;
            if (!userId) return;
            
            const user = state.users.find(u => u.username === userId);
            if (user) {
                user.status = status;
                document.getElementById('userStatus').textContent = status;
                localStorage.setItem('users', JSON.stringify(state.users));
                alert(`User ${userId} has been ${status}`);
            }
        }

        function deleteUser() {
            const userId = document.getElementById('searchUserId').value;
            if (!userId || !confirm(`Permanently delete user ${userId}?`)) return;
            
            state.users = state.users.filter(u => u.username !== userId);
            localStorage.setItem('users', JSON.stringify(state.users));
            document.getElementById('userDetails').classList.add('hidden');
            alert(`User ${userId} has been deleted`);
        }

        function showCart() {
            if (!state.currentUser) return;
            
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            
            // Get purchases from last 10 days
            const tenDaysAgo = new Date();
            tenDaysAgo.setDate(tenDaysAgo.getDate() - 10);
            
            const recentPurchases = state.currentUser.purchases.filter(p => {
                return new Date(p.date) > tenDaysAgo;
            });
            
            if (recentPurchases.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-500">У вас нет покупок за последние 10 дней</p>';
                return;
            }
            
            recentPurchases.forEach(purchase => {
                const item = state.items.find(i => i.id === purchase.itemId);
                if (!item) return;
                
                const purchaseDate = new Date(purchase.date);
                const daysAgo = Math.floor((new Date() - purchaseDate) / (1000 * 60 * 60 * 24));
                
                const itemElement = document.createElement('div');
                itemElement.className = 'bg-gray-50 p-4 rounded-lg flex items-start space-x-4';
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded">
                    <div class="flex-1">
                        <h4 class="font-bold">${item.name}</h4>
                        <p class="text-sm text-gray-600">${purchaseDate.toLocaleDateString()} (${daysAgo} ${daysAgo === 1 ? 'день' : 'дней'} назад)</p>
                        <p class="mt-2 text-sm">Местонахождение: <span class="font-mono bg-gray-200 px-2 py-1 rounded">${item.location}</span></p>
                    </div>
                `;
                cartItems.appendChild(itemElement);
            });
            
            document.getElementById('cartModal').classList.remove('hidden');
        }

        function saveUserChanges() {
            const userId = document.getElementById('searchUserId').value;
            if (!userId) return;
            
            const user = state.users.find(u => u.username === userId);
            if (user) {
                const newBalance = parseFloat(document.getElementById('userBalance').value);
                if (!isNaN(newBalance)) {
                    user.balance = newBalance;
                    localStorage.setItem('users', JSON.stringify(state.users));
                    alert('User changes saved successfully');
                }
            }
        }

        // Update account modal with current user info
        function updateAccountModal() {
            if (!state.currentUser) return;
            
            document.getElementById('accountUsername').textContent = `Username: ${state.currentUser.username}`;
            document.getElementById('accountBalance').textContent = `Balance: $${state.currentUser.balance.toFixed(2)}`;
            
            // Update payment details
            paymentDetails.innerHTML = `
                <p class="font-semibold mb-1">Bank: ${state.paymentDetails.bankName}</p>
                <p class="mb-1">Account: ${state.paymentDetails.accountNumber}</p>
                <p class="mb-1">Name: ${state.paymentDetails.accountHolder}</p>
                ${state.paymentDetails.instructions ? `<p class="text-sm mt-2">${state.paymentDetails.instructions}</p>` : ''}
            `;
            
            // Update purchases list
            purchasesList.innerHTML = '';
            
            if (state.currentUser.purchases.length === 0) {
                purchasesList.innerHTML = '<p class="text-gray-500">No purchases yet</p>';
                return;
            }
            
            state.currentUser.purchases.forEach(purchase => {
                const item = state.items.find(i => i.id === purchase.itemId);
                if (!item) return;
                
                const purchaseElement = document.createElement('div');
                purchaseElement.className = 'bg-gray-100 p-2 rounded flex justify-between items-center';
                purchaseElement.innerHTML = `
                    <div>
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-600">Purchased on ${new Date(purchase.date).toLocaleDateString()}</p>
                    </div>
                    <button class="view-location-btn px-2 py-1 bg-blue-500
</body>
</html>
